<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GBFç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --gbf-blue: #2a82b9; --gbf-dark: #1a2430; --gbf-gold: #e1ad5f; --bg-color: #f0f2f5;
            --fire: #ff4d4d; --fire-bg: #ffeded; --water: #3399ff; --water-bg: #e3f2fd;
            --earth: #b37700; --earth-bg: #fdf5e6; --wind: #2eb82e; --wind-bg: #e8f5e9;
            --light: #fbc02d; --light-bg: #fffde7; --dark: #9c27b0; --dark-bg: #f3e5f5;
            --danger: #e74c3c; --success: #2ecc71;
        }
        body { font-family: sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 80px; color: #333; }
        .main-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--gbf-dark); display: flex; z-index: 10000; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); }
        .nav-btn { flex: 1; border: none; background: none; color: #888; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; cursor: pointer; }
        .nav-btn.active { color: var(--gbf-gold); }
        .nav-btn .icon { font-size: 24px; margin-bottom: 2px; }
        .app-section { display: none; animation: fadeIn 0.3s ease; }
        .app-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Manager Style */
        .tab-menu { display: flex; justify-content: center; gap: 5px; padding: 10px; background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .sub-tab { padding: 8px 12px; border: none; border-radius: 20px; background: #ddd; font-size: 11px; font-weight: bold; cursor: pointer; }
        .sub-tab.active { background: var(--gbf-dark); color: white; }
        .backup-btn { background: #666; color: #fff; font-size: 10px; padding: 8px 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .header-box { background: white; margin: 10px; padding: 15px; border-radius: 12px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .val-unit { text-align: center; }
        .val-unit label { font-size: 10px; color: #666; display: block; }
        .val-num { font-size: 1.2em; font-weight: bold; }
        .val-num.red { color: var(--danger); }
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; padding: 10px; }
        .m-card { background: white; border-radius: 8px; padding: 12px; border-top: 5px solid #ccc; }
        .m-card.ç« { border-color: var(--fire); background: var(--fire-bg); }
        .m-card.æ°´ { border-color: var(--water); background: var(--water-bg); }
        .m-card.åœŸ { border-color: var(--earth); background: var(--earth-bg); }
        .m-card.é¢¨ { border-color: var(--wind); background: var(--wind-bg); }
        .m-card.å…‰ { border-color: var(--light); background: var(--light-bg); }
        .m-card.é—‡ { border-color: var(--dark); background: var(--dark-bg); }
        .item-list label { display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px; font-size: 13px; margin-bottom: 2px; cursor: pointer; }

        /* Trans Style */
        .t-container { padding: 10px; }
        .t-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .char-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; border-top: 4px solid #ccc; position: relative; overflow: hidden; }
        .char-item.finished { background: #f8f9fa; opacity: 0.7; }
        .char-item.finished::after { content: "COMPLETE"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); color: rgba(46, 204, 113, 0.4); font-weight: bold; font-size: 1.4rem; border: 3px solid; padding: 2px 8px; pointer-events: none; z-index: 10; }
        .t-tabs { display: flex; overflow-x: auto; gap: 5px; padding: 5px 0; }
        .t-tab-btn { padding: 6px 12px; border: none; border-radius: 10px; background: #eee; white-space: nowrap; font-size: 11px; cursor: pointer; }
        .t-tab-btn.active { background: var(--gbf-blue); color: white; }
        .t-input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 8px; margin-top: 10px; }
        .t-input-grid input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
        .group-label { grid-column: 1/-1; border-top: 2px solid var(--gbf-blue); margin-top: 10px; padding-top: 5px; font-weight: bold; font-size: 12px; color: var(--gbf-blue); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: left; }
        .status-ng { color: var(--danger); font-weight: bold; }
        .btn-action { padding: 12px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; display: inline-block; text-align: center; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<nav class="main-nav">
    <button class="nav-btn active" onclick="switchMainTab('manager', this)"><span class="icon">ğŸ“¦</span><span>ç´ æç®¡ç†</span></button>
    <button class="nav-btn" onclick="switchMainTab('trans', this)"><span class="icon">âš¡</span><span>é™ç•Œè¶…è¶Š</span></button>
</nav>

<section id="section-manager" class="app-section active">
    <div class="tab-menu">
        <button class="sub-tab active" id="btn-quartz" onclick="switchMSubTab('quartz')">ã‚¯ã‚©ãƒ¼ãƒ„</button>
        <button class="sub-tab" id="btn-shoukaku" onclick="switchMSubTab('shoukaku')">æ™¶æ ¸</button>
        <button class="sub-tab" id="btn-tense" onclick="switchMSubTab('tense')">å¤©æ˜Ÿ</button>
        <div style="display:flex; gap:5px; margin-left: 5px;">
            <button class="backup-btn" onclick="exportMData()">ä¿å­˜</button>
            <button class="backup-btn" onclick="document.getElementById('importFileM').click()">å¾©å…ƒ</button>
            <input type="file" id="importFileM" style="display:none" onchange="importMData(event)">
        </div>
    </div>
    <div class="header-box">
        <div class="val-unit"><label id="m-total-label">ç›®æ¨™å€‹æ•°</label><div class="val-num" id="m-grand-total">0</div></div>
        <div id="m-weapon-box" class="val-unit" style="display:none"><label>æ­¦å™¨æ‰€æŒæ™¶æ ¸</label><div class="val-num" id="m-weapon-val">0</div></div>
        <div id="m-stock-box" class="val-unit"><label id="m-stock-label">æ‰€æŒæ•°</label><input type="number" id="m-stock-input" style="width:70px; text-align:center" oninput="saveM()"></div>
        <div class="val-unit"><label id="m-need-label">ä¸è¶³åˆ†</label><div class="val-num red" id="m-needed-total">0</div></div>
    </div>
    <div id="m-container" class="grid-cards"></div>
</section>

<section id="section-trans" class="app-section">
    <div class="t-container">
        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘  ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-action" style="background:#555; flex:1;" onclick="downloadT()">è¨­å®šã‚’æ›¸ãå‡ºã—</button>
                <button class="btn-action" style="background:#555; flex:1;" onclick="document.getElementById('importFileT').click()">è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
                <input type="file" id="importFileT" style="display:none" accept=".json" onchange="uploadTFile(event)">
            </div>
        </div>

        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘¡ ã‚­ãƒ£ãƒ©é€²æ—</h3>
            <div class="char-grid" id="t-char-settings"></div>
        </div>

        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘¢ æ‰€æŒæ•°å…¥åŠ›</h3>
            <div class="t-tabs" id="t-attr-tabs">
                <button class="t-tab-btn active" onclick="switchTInputTab('Common')">å…±é€š / å€‹åˆ¥</button>
                <button class="t-tab-btn" onclick="switchTInputTab('ç«')">ç«</button>
                <button class="t-tab-btn" onclick="switchTInputTab('æ°´')">æ°´</button>
                <button class="t-tab-btn" onclick="switchTInputTab('åœŸ')">åœŸ</button>
                <button class="t-tab-btn" onclick="switchTInputTab('é¢¨')">é¢¨</button>
                <button class="t-tab-btn" onclick="switchTInputTab('å…‰')">å…‰</button>
                <button class="t-tab-btn" onclick="switchTInputTab('é—‡')">é—‡</button>
            </div>
            <div class="t-input-grid" id="t-stock-inputs"></div>
        </div>

        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘£ ä¸è¶³ç´ æã®é›†è¨ˆ</h3>
            <div id="t-result-container"></div>
            <button class="btn-action" style="background:var(--success); width:100%; margin-top:15px; font-size: 16px;" onclick="saveT()">ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</button>
        </div>
    </div>
</section>

<script>
const charMaster = [
    {n:"ä¸€ä¼æ§", j:"ã‚¦ãƒ¼ãƒ", a:"æ°´", wt:"æ§", r:["ç«","æ°´"], id:"ä¸€ç•ª"},
    {n:"äºŒç‹å¼“", j:"ã‚½ãƒ¼ãƒ³", a:"å…‰", wt:"å¼“", r:["ç«","é¢¨"], id:"äºŒç•ª"},
    {n:"ä¸‰å¯…æ–§", j:"ã‚µãƒ©ãƒ¼ã‚µ", a:"åœŸ", wt:"æ–§", r:["åœŸ","æ°´"], id:"ä¸‰ç•ª"},
    {n:"å››å¤©åˆƒ", j:"ã‚«ãƒˆãƒ«", a:"æ°´", wt:"çŸ­å‰£", r:["ç«","æ°´"], id:"å››ç•ª"},
    {n:"äº”ç¥æ–", j:"ãƒ•ãƒ¥ãƒ³ãƒ•", a:"å…‰", wt:"æ–", r:["æ°´","åœŸ"], id:"äº”ç•ª"},
    {n:"å…­å´©æ‹³", j:"ã‚·ã‚¹", a:"é—‡", wt:"æ‹³", r:["ç«","é¢¨"], id:"å…­ç•ª"},
    {n:"ä¸ƒæ˜Ÿå‰£", j:"ã‚·ã‚¨ãƒ†", a:"é¢¨", wt:"å‰£", r:["é¢¨","åœŸ"], id:"ä¸ƒç•ª"},
    {n:"å…«å‘½åˆ‡", j:"ã‚ªã‚¯ãƒˆãƒ¼", a:"åœŸ", wt:"åˆ€", r:["åœŸ","é¢¨"], id:"å…«ç•ª"},
    {n:"ä¹ç•Œç´", j:"ãƒ‹ã‚ª", a:"é¢¨", wt:"ç´", r:["é¢¨","åœŸ"], id:"ä¹ç•ª"},
    {n:"åç‹¼é›·", j:"ã‚¨ãƒƒã‚»ãƒ«", a:"ç«", wt:"éŠƒ", r:["ç«","åœŸ"], id:"åç•ª"}
];

const materialOrder = ["å‰£", "çŸ­å‰£", "æ§", "æ–§", "æ–", "éŠƒ", "æ‹³", "å¼“", "ç´", "åˆ€"];
const sortedWeaponMaster = [...charMaster].sort((a, b) => materialOrder.indexOf(a.wt) - materialOrder.indexOf(b.wt));

const M_STORAGE_KEY = 'gbf_manager_data_unified';
const T_STORAGE_KEY = 'GBF_TEN_TRANS_APP_DATA_V10';

function getFormattedDate() {
    const d = new Date();
    return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
}

let mCurrentTab = 'quartz';
function switchMainTab(target, btn) {
    document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('section-' + target).classList.add('active');
    btn.classList.add('active');
}
function switchMSubTab(tab) {
    mCurrentTab = tab;
    document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + tab).classList.add('active');
    document.getElementById('m-weapon-box').style.display = (tab === 'shoukaku') ? 'block' : 'none';
    document.getElementById('m-stock-box').style.display = (tab === 'tense') ? 'none' : 'block';
    renderM();
}

function renderM() {
    const container = document.getElementById('m-container'); container.innerHTML = '';
    if (mCurrentTab === 'quartz') {
        const sages = [{a:"ç«", s:["ã‚¢ãƒ©ãƒŠãƒ³","ãƒ•ãƒ©ã‚¦"]},{a:"æ°´",s:["ãƒ†ãƒ¬ã‚µ","ãƒãƒ¼ã‚¼"]},{a:"åœŸ",s:["ã‚«ã‚¤ãƒ ","ãƒ­ãƒ™ãƒªã‚¢"]},{a:"é¢¨",s:["ã‚¨ã‚¹ã‚¿","ã‚«ãƒƒãƒ„ã‚§"]},{a:"å…‰",s:["ã‚¬ã‚¤ã‚¼ãƒ³"]},{a:"é—‡",s:["ãƒ‹ãƒ¼ã‚¢"]}];
        sages.forEach((g, i) => {
            let h = `<div class="m-card ${g.a}"><h3>${g.a}å±æ€§</h3>`;
            g.s.forEach((s, si) => {
                h += `<strong>${s}</strong><div class="item-list">`;
                [5,5,10,20,20,30].forEach((c, ci) => h += `<label><input type="checkbox" class="m-cb" data-cost="${c}" id="q-${i}-${si}-${ci}" onchange="saveM()">ç¤:${ci}å‡¸(${c})</label>`);
                h += `<label><input type="checkbox" class="m-cb" data-cost="30" id="q-${i}-${si}-abi" onchange="saveM()">4ã‚¢ãƒ“(30)</label></div>`;
            });
            h += `<strong>å…±é€š</strong><div class="item-list">`;
            ["çµ‚æœ«(ç¥)","çµ‚æœ«(ãƒ)","ç ´å£Š"].forEach(n => h += `<label><input type="checkbox" class="m-cb" data-cost="20" id="q-${i}-${n}" onchange="saveM()">${n}(20)</label>`);
            container.innerHTML += h + `</div></div>`;
        });
    } else if (mCurrentTab === 'shoukaku') {
        sortedWeaponMaster.forEach((m, i) => {
            let h = `<div class="m-card ${m.a}"><h3>æ¥µæ˜Ÿå™¨:${m.wt}</h3><div class="item-list">`;
            [{l:"3å‡¸ä½œæˆ",c:45},{l:"4å‡¸è§£æ”¾",c:45},{l:"5å‡¸è§£æ”¾",c:80},{l:"è¦šé†’å¼·åŒ–",c:170}].forEach((s, si) => h += `<label><input type="checkbox" class="m-cb" data-cost="${s.c}" id="s-${m.j}-${si}" onchange="saveM()">${s.l}(${s.c})</label>`);
            h += `</div><div style="margin-top:10px; font-size:12px">æ‰€æŒ(ç„¡å‡¸): <input type="number" id="ms-${m.j}" style="width:40px" oninput="saveM()"> æœ¬<br>ä¸è¶³: <span id="msd-${m.j}" style="color:red; font-weight:bold">0</span>å€‹</div></div>`;
            container.innerHTML += h;
        });
    } else if (mCurrentTab === 'tense') {
        charMaster.forEach((t, i) => {
            let h = `<div class="m-card ${t.a}"><h3>${t.id}å¤©æ˜Ÿã®æ¬ ç‰‡(${t.n} / ${t.j})</h3><div class="item-list">`;
            [{l:"è¶…è¶Š120",c:50},{l:"æ¥µæ˜Ÿ4å‡¸",c:20},{l:"æ¥µæ˜Ÿ5å‡¸",c:20},{l:"å…‰è·¡Lv4",c:20}].forEach((s, si) => h += `<label><input type="checkbox" class="m-cb" data-cost="${s.c}" id="t-${t.j}-${si}" onchange="saveM()">${s.l}(${s.c})</label>`);
            h += `</div><div style="margin-top:10px; font-size:11px">å¤©æ˜Ÿå™¨æ‰€æŒ: <input type="number" id="mt-${t.j}" style="width:40px" oninput="saveM()"> æœ¬<br>ä¸è¶³æ¬ ç‰‡: <span id="mtd-${t.j}" style="color:red; font-weight:bold">0</span> (è¦:<span id="mtw-${t.j}">0</span>æœ¬)</div></div>`;
            container.innerHTML += h;
        });
    }
    loadM();
}

function saveM() {
    const s = JSON.parse(localStorage.getItem(M_STORAGE_KEY) || '{"checks":{},"stocks":{},"headStocks":{}}');
    document.querySelectorAll('.m-cb').forEach(c => s.checks[c.id] = c.checked);
    charMaster.forEach(m => {
        const msEl = document.getElementById(`ms-${m.j}`); if(msEl) s.stocks[`s-${m.j}`] = parseInt(msEl.value)||0;
        const mtEl = document.getElementById(`mt-${m.j}`); if(mtEl) s.stocks[`t-${m.j}`] = parseInt(mtEl.value)||0;
    });
    if(mCurrentTab!=='tense') {
        const hsInput = document.getElementById('m-stock-input');
        if(hsInput) s.headStocks[mCurrentTab] = parseInt(hsInput.value)||0;
    }
    localStorage.setItem(M_STORAGE_KEY, JSON.stringify(s));
    calcM(s);
}

function calcM(data) {
    let total = 0; document.querySelectorAll('.m-cb').forEach(c => { if(!c.checked) total += parseInt(c.dataset.cost); });
    let conv = 0;
    if(mCurrentTab==='shoukaku') {
        charMaster.forEach(m => {
            const c = data.stocks[`s-${m.j}`]||0; conv += (c*15);
            let n = 0; [0,1,2,3].forEach(si=>{ const cb=document.getElementById(`s-${m.j}-${si}`); if(cb && !cb.checked) n+=parseInt(cb.dataset.cost); });
            const diffEl = document.getElementById(`msd-${m.j}`); if(diffEl) diffEl.textContent = Math.max(0, n-(c*15));
        });
        document.getElementById('m-weapon-val').textContent = conv;
    }
    if(mCurrentTab==='tense') {
        let ts=0; charMaster.forEach(m => {
            const c=data.stocks[`t-${m.j}`]||0; let n=0; [0,1,2,3].forEach(si=>{ const cb=document.getElementById(`t-${m.j}-${si}`); if(cb && !cb.checked) n+=parseInt(cb.dataset.cost); });
            const cur=Math.floor(c/4)*5; const df=Math.max(0, n-cur); ts+=df;
            const dEl = document.getElementById(`mtd-${m.j}`); if(dEl) dEl.textContent=df;
            const wEl = document.getElementById(`mtw-${m.j}`); if(wEl) wEl.textContent=Math.max(0,(Math.ceil(df/5)*4)-(c%4));
        });
        document.getElementById('m-needed-total').textContent = ts;
    } else {
        const hs = data.headStocks[mCurrentTab]||0;
        document.getElementById('m-needed-total').textContent = Math.max(0, total-(hs+conv));
    }
    document.getElementById('m-grand-total').textContent = total;
}

function loadM() {
    const d = JSON.parse(localStorage.getItem(M_STORAGE_KEY) || '{"checks":{},"stocks":{},"headStocks":{}}');
    document.querySelectorAll('.m-cb').forEach(c => { if(d.checks[c.id]!==undefined) c.checked=d.checks[c.id]; });
    charMaster.forEach(m => {
        const msEl = document.getElementById(`ms-${m.j}`); if(msEl) msEl.value = d.stocks[`s-${m.j}`]||0;
        const mtEl = document.getElementById(`mt-${m.j}`); if(mtEl) mtEl.value = d.stocks[`t-${m.j}`]||0;
    });
    if(mCurrentTab!=='tense') {
        const el = document.getElementById('m-stock-input');
        if(el) el.value = d.headStocks[mCurrentTab]||0;
    }
    calcM(d);
}

function exportMData() {
    const d = localStorage.getItem(M_STORAGE_KEY); if(!d) return;
    const b=new Blob([d],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a');
    a.href=u; a.download=`gbf_manager_ç´ æç®¡ç†_${getFormattedDate()}.json`; a.click();
}

function importMData(e) {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const json = JSON.parse(ev.target.result);
            localStorage.setItem(M_STORAGE_KEY, JSON.stringify(json));
            renderM();
            alert("ç´ æç®¡ç†ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
        } catch(err) { alert("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"); }
    };
    reader.readAsText(file);
}

/* --- Trans Logic --- */
const commonOrder = ["ç¢§éº—ã®è¨¼", "ç©¶ç«Ÿã®è¨¼", "æ „å…‰ã®è¨¼", "è¦‡è€…ã®è¨¼", "ãƒ«ãƒ”", "ãƒ’ãƒ’ã‚¤ãƒ­ã‚«ãƒ", "ãƒ€ãƒã‚¹ã‚«ã‚¹éª¸æ™¶", "æ˜Ÿæ™¶ã®æ¬ ç‰‡", "JP", "å®æ™¶çŸ³", "é»„é¾ã®ãƒã‚°ãƒŠã‚¢ãƒ‹ãƒ", "é»’éº’éºŸã®ãƒã‚°ãƒŠã‚¢ãƒ‹ãƒ", "çµ‚æœ«ã®æš—æ™¶", "æ¼†é»’ã®æ£˜ç¿…", "ç‹¡çŸ¥ã®é­”è§’", "ãƒãƒç´«é›»è§’", "çœŸé¾ã®é‡‘é±—"];
const attrMats = ["çœŸãªã‚‹ã‚¢ãƒ‹ãƒ", "å…­ç«œç´ æ", "å…‰è¼ª", "ãƒã‚°ãƒŠIIãƒã‚°ãƒŠã‚¢ãƒ‹ãƒ", "ãƒ—ã‚·ãƒ¥ã‚±ãƒ¼", "å±æ€§ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ", "ç«œç ", "ãƒ–ãƒ©ã‚¤ãƒˆ", "ä¸‹ä½å®ç ", "ã‚¸ãƒ¼ãƒ³"];
let tData = { chars: {}, stocks: {} };
let tActiveTab = 'Common';
const masterDataT = {
    110: { common:{"ãƒ«ãƒ”":100000, "ãƒ€ãƒã‚¹ã‚«ã‚¹éª¸æ™¶":20, "ãƒ’ãƒ’ã‚¤ãƒ­ã‚«ãƒ":1, "æ˜Ÿæ™¶ã®æ¬ ç‰‡":7500}, attr:{"å…­ç«œç´ æ":50, "å…‰è¼ª":80, "ä¸‹ä½å®ç ":7500, "ã‚¸ãƒ¼ãƒ³":7500}, spec:{"éŠ€ç‰‡":200, "æœ½ã¡æ­¦å™¨":120} },
    120: { common:{"ãƒ«ãƒ”":5000000, "ç©¶ç«Ÿã®è¨¼":100, "JP":20000, "æ „å…‰ã®è¨¼":1500, "è¦‡è€…ã®è¨¼":300, "å®æ™¶çŸ³":1000, "ãƒãƒç´«é›»è§’":100}, attr:{"çœŸãªã‚‹ã‚¢ãƒ‹ãƒ":30, "ãƒã‚°ãƒŠIIãƒã‚°ãƒŠã‚¢ãƒ‹ãƒ":50, "ãƒ—ã‚·ãƒ¥ã‚±ãƒ¼":300, "ä¸‹ä½å®ç ":2500, "ã‚¸ãƒ¼ãƒ³":2500}, spec:{"æœ½ã¡æ­¦å™¨":40, "å¤©æ˜Ÿå™¨":40} },
    130: { common:{"ç¢§éº—ã®è¨¼":1} },
    140: { common:{"ãƒ«ãƒ”":5000000, "çœŸé¾ã®é‡‘é±—":50}, attr:{"ãƒ–ãƒ©ã‚¤ãƒˆ":30, "å±æ€§ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ":2000, "ç«œç ":300}, spec:{"æ­¦å™¨ã‚¨ãƒ¬":2000} },
    150: { common:{"çµ‚æœ«ã®æš—æ™¶":30, "æ¼†é»’ã®æ£˜ç¿…":30, "ç‹¡çŸ¥ã®é­”è§’":30, "ç¢§éº—ã®è¨¼":1} }
};

function initT() {
    const saved = localStorage.getItem(T_STORAGE_KEY);
    if(saved) { try { tData = JSON.parse(saved); } catch(e) {} }
    renderTSettings();
}

function renderTSettings() {
    const container = document.getElementById('t-char-settings'); container.innerHTML = '';
    charMaster.forEach(c => {
        if(!tData.chars[c.j]) tData.chars[c.j] = {cur:100, tar:100, fin:false};
        const d = tData.chars[c.j];
        const attrClass = {ç«:'fire',æ°´:'water',åœŸ:'earth',é¢¨:'wind',å…‰:'light',é—‡:'dark'}[c.a];
        container.innerHTML += `<div class="char-item ${d.fin ? 'finished' : ''}" style="border-top-color:var(--${attrClass})">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px"><strong style="font-size:13px">${c.j}</strong><input type="checkbox" onchange="toggleTFin('${c.j}',this.checked)" ${d.fin?'checked':''}></div>
            <div style="display:flex; align-items:center; gap:2px;"><select style="flex:1" onchange="updateTChar('${c.j}','cur',this.value)" ${d.fin?'disabled':''}>${[100,110,120,130,140,150].map(v=>`<option value="${v}" ${d.cur==v?'selected':''}>${v}</option>`)}</select><span>â–¶</span><select style="flex:1" onchange="updateTChar('${c.j}','tar',this.value)" ${d.fin?'disabled':''}>${[100,110,120,130,140,150].map(v=>`<option value="${v}" ${d.tar==v?'selected':''}>${v}</option>`)}</select></div></div>`;
    });
    switchTInputTab(tActiveTab);
    calcT();
}

function updateTChar(n, k, v) { tData.chars[n][k] = parseInt(v); calcT(); }
function toggleTFin(n, c) { tData.chars[n].fin = c; renderTSettings(); }

function switchTInputTab(t) {
    tActiveTab = t;
    document.querySelectorAll('.t-tab-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(t)));
    const container = document.getElementById('t-stock-inputs'); container.innerHTML = '';
    
    if(t === 'Common') {
        commonOrder.forEach(m => renderTInputItem(container, m, m));
        
        container.innerHTML += `<div class="group-label">ã€éŠ€ç‰‡ã€‘</div>`;
        sortedWeaponMaster.forEach(w => renderTInputItem(container, `${w.wt}ã®éŠ€ç‰‡`, `spec-éŠ€ç‰‡-${w.j}`));
        
        container.innerHTML += `<div class="group-label">ã€æ­¦å™¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã€‘</div>`;
        sortedWeaponMaster.forEach(w => renderTInputItem(container, `${w.wt}ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ`, `spec-æ­¦å™¨ã‚¨ãƒ¬-${w.j}`));

        container.innerHTML += `<div class="group-label">ã€å¤©æ˜Ÿå™¨ (ç„¡å‡¸æœ¬æ•°)ã€‘</div>`;
        sortedWeaponMaster.forEach(w => renderTInputItem(container, `${w.wt} (${w.n})`, `spec-å¤©æ˜Ÿå™¨-${w.j}`));

        container.innerHTML += `<div class="group-label">ã€æœ½ã¡æ­¦å™¨ (ç„¡å‡¸æœ¬æ•°)ã€‘</div>`;
        sortedWeaponMaster.forEach(w => renderTInputItem(container, `${w.wt}ã®æœ½ã¡æ­¦å™¨`, `spec-æœ½ã¡æ­¦å™¨-${w.j}`));

    } else { 
        attrMats.forEach(m => renderTInputItem(container, m, `${t}-${m}`)); 
    }
}

function renderTInputItem(container, label, id) {
    const val = tData.stocks[id] || 0;
    container.innerHTML += `<div><label style="display:block;font-size:10px;margin-bottom:2px;">${label}</label><input type="number" value="${val}" oninput="updateTStock('${id}',this.value)"></div>`;
}
function updateTStock(id, v) { tData.stocks[id] = parseInt(v)||0; calcT(); }

function calcT() {
    const needed = {};
    charMaster.forEach(c => {
        const d = tData.chars[c.j]; if(d.fin || d.tar <= d.cur) return;
        for(let lv in masterDataT) {
            const num = parseInt(lv);
            if(num > d.cur && num <= d.tar) {
                for(let m in masterDataT[lv].common) needed[m] = (needed[m]||0) + masterDataT[lv].common[m];
                for(let m in masterDataT[lv].attr) {
                    let key = `${c.a}-${m}`;
                    if(m === "å…‰è¼ª" && (c.a === "å…‰" || c.a === "é—‡")) { c.r.forEach(r => { let rkey = `${r}-å…‰è¼ª`; needed[rkey] = (needed[rkey]||0) + masterDataT[lv].attr[m]/2; }); }
                    else { needed[key] = (needed[key]||0) + masterDataT[lv].attr[m]; }
                }
                if(masterDataT[lv].spec) {
                    if(masterDataT[lv].spec["éŠ€ç‰‡"]) { let k=`spec-éŠ€ç‰‡-${c.j}`; needed[k] = (needed[k]||0) + 200; }
                    if(masterDataT[lv].spec["æ­¦å™¨ã‚¨ãƒ¬"]) { let k=`spec-æ­¦å™¨ã‚¨ãƒ¬-${c.j}`; needed[k] = (needed[k]||0) + 2000; }
                    if(masterDataT[lv].spec["å¤©æ˜Ÿå™¨"]) { let k=`spec-å¤©æ˜Ÿå™¨-${c.j}`; needed[k] = (needed[k]||0) + 40; }
                    if(masterDataT[lv].spec["æœ½ã¡æ­¦å™¨"]) { 
                        let k=`spec-æœ½ã¡æ­¦å™¨-${c.j}`;
                        let amt = masterDataT[lv].spec["æœ½ã¡æ­¦å™¨"];
                        needed[k] = (needed[k]||0) + amt; 
                    }
                }
                if(num === 140) { const ak = (c.a==="ç«"||c.a==="é—‡"||c.a==="æ°´"||c.a==="é¢¨") ? "é»’éº’éºŸã®ãƒã‚°ãƒŠã‚¢ãƒ‹ãƒ" : "é»„é¾ã®ãƒã‚°ãƒŠã‚¢ãƒ‹ãƒ"; needed[ak] = (needed[ak]||0)+30; }
            }
        }
    });
    const resContainer = document.getElementById('t-result-container'); resContainer.innerHTML = '';
    const categories = ["å…±é€š", "éŠ€ç‰‡", "æ­¦å™¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ", "å¤©æ˜Ÿå™¨", "æœ½ã¡æ­¦å™¨", "ç«", "æ°´", "åœŸ", "é¢¨", "å…‰", "é—‡"];
    categories.forEach(cat => {
        let items = [];
        if(cat === "å…±é€š") items = Object.keys(needed).filter(k => commonOrder.includes(k));
        else if(cat === "éŠ€ç‰‡") items = sortedWeaponMaster.map(w => `spec-éŠ€ç‰‡-${w.j}`).filter(k => needed[k]);
        else if(cat === "æ­¦å™¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ") items = sortedWeaponMaster.map(w => `spec-æ­¦å™¨ã‚¨ãƒ¬-${w.j}`).filter(k => needed[k]);
        else if(cat === "å¤©æ˜Ÿå™¨") items = sortedWeaponMaster.map(w => `spec-å¤©æ˜Ÿå™¨-${w.j}`).filter(k => needed[k]);
        else if(cat === "æœ½ã¡æ­¦å™¨") items = sortedWeaponMaster.map(w => `spec-æœ½ã¡æ­¦å™¨-${w.j}`).filter(k => needed[k]);
        else items = Object.keys(needed).filter(k => k.startsWith(cat + "-"));
        
        if(items.length > 0) {
            let h = `<div style="background:#eee; padding:5px; margin:10px 0 5px; font-weight:bold; border-radius:4px; font-size:12px;">${cat}</div><table>`;
            items.forEach(k => {
                const s = tData.stocks[k]||0; const df = needed[k]-s; let displayK = k;
                if(k.startsWith("spec-éŠ€ç‰‡-")) { const w = charMaster.find(wm => wm.j === k.replace("spec-éŠ€ç‰‡-", "")); displayK = w ? `${w.wt}ã®éŠ€ç‰‡` : k; }
                else if(k.startsWith("spec-æ­¦å™¨ã‚¨ãƒ¬-")) { const w = charMaster.find(wm => wm.j === k.replace("spec-æ­¦å™¨ã‚¨ãƒ¬-", "")); displayK = w ? `${w.wt}ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ` : k; }
                else if(k.startsWith("spec-å¤©æ˜Ÿå™¨-")) { const w = charMaster.find(wm => wm.j === k.replace("spec-å¤©æ˜Ÿå™¨-", "")); displayK = w ? `${w.wt} (${w.n})` : k; }
                else if(k.startsWith("spec-æœ½ã¡æ­¦å™¨-")) { const w = charMaster.find(wm => wm.j === k.replace("spec-æœ½ã¡æ­¦å™¨-", "")); displayK = w ? `${w.wt}ã®æœ½ã¡æ­¦å™¨` : k; }
                else if(k.includes("-")) { displayK = k.split("-")[1]; }
                h += `<tr class="${df<=0?'':'status-ng'}"><td>${df<=0?'âœ“ ':''}${displayK}</td><td style="text-align:right">${needed[k].toLocaleString()}</td><td style="text-align:right">${df<=0?'-':df.toLocaleString()}</td></tr>`;
            });
            resContainer.innerHTML += h + `</table>`;
        }
    });
}
function saveT() { localStorage.setItem(T_STORAGE_KEY, JSON.stringify(tData)); alert("ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸ"); }
function downloadT() {
    const b = new Blob([JSON.stringify(tData)], {type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a');
    a.href = u; a.download = `gbf_manager_é™ç•Œè¶…è¶Š_${getFormattedDate()}.json`; a.click();
}
function uploadTFile(e) {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader(); reader.onload = (ev) => { try { tData = JSON.parse(ev.target.result); renderTSettings(); } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); } }; reader.readAsText(file);
}

window.onload = () => {
    switchMSubTab('quartz');
    initT();
};
</script>
</body>
</html>
