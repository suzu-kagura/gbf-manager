<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GBF çµ±åˆç®¡ç†ãƒ„ãƒ¼ãƒ« v2.1</title>
    <style>
        /* --- çµ±åˆåŸºç›¤ã‚¹ã‚¿ã‚¤ãƒ« --- */
        :root {
            --gbf-blue: #2a82b9;
            --gbf-dark: #1a2430;
            --gbf-gold: #e1ad5f;
            --bg-color: #f0f2f5;
            --fire: #ff4d4d; --fire-bg: #ffeded;
            --water: #3399ff; --water-bg: #e3f2fd;
            --earth: #b37700; --earth-bg: #fdf5e6;
            --wind: #2eb82e; --wind-bg: #e8f5e9;
            --light: #fbc02d; --light-bg: #fffde7;
            --dark: #9c27b0; --dark-bg: #f3e5f5;
            --danger: #e74c3c; --success: #2ecc71;
        }

        body {
            font-family: sans-serif;
            background: var(--bg-color);
            margin: 0; padding: 0; padding-bottom: 80px;
            color: #333;
        }

        /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .main-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--gbf-dark); display: flex; z-index: 10000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .nav-btn {
            flex: 1; border: none; background: none; color: #888;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; cursor: pointer;
        }
        .nav-btn.active { color: var(--gbf-gold); }
        .nav-btn .icon { font-size: 24px; margin-bottom: 2px; }

        .app-section { display: none; animation: fadeIn 0.3s ease; }
        .app-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Tool 1 (Manager) å°‚ç”¨ --- */
        .tab-menu { display: flex; justify-content: center; gap: 5px; padding: 10px; background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .sub-tab { padding: 8px 12px; border: none; border-radius: 20px; background: #ddd; font-size: 11px; font-weight: bold; }
        .sub-tab.active { background: var(--gbf-dark); color: white; }
        .backup-btn { background: #666; color: #fff; font-size: 10px; padding: 8px 10px; border-radius: 6px; border: none; font-weight: bold; }
        
        .header-box { background: white; margin: 10px; padding: 15px; border-radius: 12px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .val-unit { text-align: center; }
        .val-unit label { font-size: 10px; color: #666; display: block; }
        .val-num { font-size: 1.2em; font-weight: bold; }
        .val-num.red { color: var(--danger); }
        
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; padding: 10px; }
        .m-card { background: white; border-radius: 8px; padding: 12px; border-top: 5px solid #ccc; }
        .m-card.ç« { border-color: var(--fire); background: var(--fire-bg); }
        .m-card.æ°´ { border-color: var(--water); background: var(--water-bg); }
        .m-card.åœŸ { border-color: var(--earth); background: var(--earth-bg); }
        .m-card.é¢¨ { border-color: var(--wind); background: var(--wind-bg); }
        .m-card.å…‰ { border-color: var(--light); background: var(--light-bg); }
        .m-card.é—‡ { border-color: var(--dark); background: var(--dark-bg); }
        .item-list label { display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px; font-size: 13px; margin-bottom: 2px; }

        /* --- Tool 2 (Trans) å°‚ç”¨ --- */
        .t-container { padding: 10px; }
        .t-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        
        /* COMPLETEã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .char-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; border-top: 4px solid #ccc; position: relative; overflow: hidden; }
        .char-item.finished { background: #f8f9fa; opacity: 0.7; }
        .char-item.finished::after { 
            content: "COMPLETE"; 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) rotate(-20deg); 
            color: rgba(46, 204, 113, 0.4); 
            font-weight: bold; font-size: 1.4rem; 
            border: 3px solid; padding: 2px 8px; 
            pointer-events: none; z-index: 10; 
        }

        .t-tabs { display: flex; overflow-x: auto; gap: 5px; padding: 5px 0; }
        .t-tab-btn { padding: 6px 12px; border: none; border-radius: 10px; background: #eee; white-space: nowrap; font-size: 11px; }
        .t-tab-btn.active { background: var(--gbf-blue); color: white; }
        .t-input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .t-input-grid input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: left; }
        .status-ng { color: var(--danger); font-weight: bold; }
        
        /* å…±é€šãƒœã‚¿ãƒ³ */
        .btn-action { padding: 12px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; display: inline-block; text-align: center; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<nav class="main-nav">
    <button class="nav-btn active" onclick="switchMainTab('manager', this)">
        <span class="icon">ğŸ“¦</span><span>ç´ æç®¡ç†</span>
    </button>
    <button class="nav-btn" onclick="switchMainTab('trans', this)">
        <span class="icon">âš¡</span><span>é™ç•Œè¶…è¶Š</span>
    </button>
</nav>

<section id="section-manager" class="app-section active">
    <div class="tab-menu">
        <button class="sub-tab active" id="btn-quartz" onclick="switchMSubTab('quartz')">ã‚¯ã‚©ãƒ¼ãƒ„</button>
        <button class="sub-tab" id="btn-shoukaku" onclick="switchMSubTab('shoukaku')">æ™¶æ ¸</button>
        <button class="sub-tab" id="btn-tense" onclick="switchMSubTab('tense')">å¤©æ˜Ÿ</button>
        <div style="display:flex; gap:5px; margin-left: 5px;">
            <button class="backup-btn" onclick="exportMData()">ä¿å­˜</button>
            <button class="backup-btn" onclick="document.getElementById('importFileM').click()">å¾©å…ƒ</button>
            <input type="file" id="importFileM" style="display:none" onchange="importMData(event)">
        </div>
    </div>

    <div class="header-box">
        <div class="val-unit"><label id="m-total-label">ç›®æ¨™å€‹æ•°</label><div class="val-num" id="m-grand-total">0</div></div>
        <div id="m-weapon-box" class="val-unit" style="display:none"><label>æ­¦å™¨æ‰€æŒæ™¶æ ¸</label><div class="val-num" id="m-weapon-val">0</div></div>
        <div id="m-stock-box" class="val-unit"><label id="m-stock-label">æ‰€æŒæ•°</label><input type="number" id="m-stock-input" style="width:70px; text-align:center" oninput="saveM()"></div>
        <div class="val-unit"><label id="m-need-label">ä¸è¶³åˆ†</label><div class="val-num red" id="m-needed-total">0</div></div>
    </div>

    <div id="m-container" class="grid-cards"></div>
</section>

<section id="section-trans" class="app-section">
    <div class="t-container">
        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘  ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-action" style="background:#555; flex:1;" onclick="downloadT()">è¨­å®šã‚’ä¿å­˜</button>
                <button class="btn-action" style="background:#555; flex:1;" onclick="document.getElementById('importFileT').click()">è¨­å®šã‚’èª­è¾¼</button>
                <input type="file" id="importFileT" style="display:none" accept=".json" onchange="uploadTFile(event)">
            </div>
        </div>

        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘¡ å„ã‚­ãƒ£ãƒ©ã®é€²æ—è¨­å®š</h3>
            <div class="char-grid" id="t-char-settings"></div>
        </div>

        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘¢ ç´ æã®æ‰€æŒæ•°å…¥åŠ›</h3>
            <div class="t-tabs" id="t-attr-tabs">
                <button class="t-tab-btn active" onclick="switchTInputTab('Common')">å…±é€š</button>
                <button class="t-tab-btn" onclick="switchTInputTab('ç«')">ç«</button>
                <button class="t-tab-btn" onclick="switchTInputTab('æ°´')">æ°´</button>
                <button class="t-tab-btn" onclick="switchTInputTab('åœŸ')">åœŸ</button>
                <button class="t-tab-btn" onclick="switchTInputTab('é¢¨')">é¢¨</button>
                <button class="t-tab-btn" onclick="switchTInputTab('å…‰')">å…‰</button>
                <button class="t-tab-btn" onclick="switchTInputTab('é—‡')">é—‡</button>
            </div>
            <div class="t-input-grid" id="t-stock-inputs"></div>
        </div>

        <div class="t-card">
            <h3 style="margin:0 0 10px 0; font-size:14px">â‘£ ä¸è¶³ç´ æã®é›†è¨ˆçµæœ</h3>
            <div id="t-result-container"></div>
            <button class="btn-action" style="background:var(--success); width:100%; margin-top:15px; font-size: 16px;" onclick="saveT()">ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼ˆç¢ºå®šï¼‰</button>
        </div>
    </div>
</section>

<script>
/* JavaScriptéƒ¨åˆ†ã¯å¤‰æ›´ãªã— */
/* ==========================================
   å…±é€šï¼šãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
   ========================================== */
function switchMainTab(target, btn) {
    document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('section-' + target).classList.add('active');
    btn.classList.add('active');
    window.scrollTo(0,0);
}

/* ==========================================
   Tool 1: GBF Manager (Quartz/Shoukaku/Tense)
   ========================================== */
let mCurrentTab = 'quartz';
const M_STORAGE_KEY = 'gbf_manager_data_unified';
const weaponMaster = [
    {id: 1, n: "ä¸€ã®æ¬ ç‰‡", j: "ã‚¦ãƒ¼ãƒ", w: "ä¸€ä¹ƒçŸ›", a: "æ°´", wt: "æ§"},
    {id: 2, n: "äºŒã®æ¬ ç‰‡", j: "ã‚½ãƒ¼ãƒ³", w: "äºŒä¹ƒå¼“", a: "å…‰", wt: "å¼“"},
    {id: 3, n: "ä¸‰ã®æ¬ ç‰‡", j: "ã‚µãƒ©ãƒ¼ã‚µ", w: "ä¸‰ä¹ƒæ–§", a: "åœŸ", wt: "æ–§"},
    {id: 4, n: "å››ã®æ¬ ç‰‡", j: "ã‚«ãƒˆãƒ«", w: "å››ä¹ƒçŸ­å‰£", a: "æ°´", wt: "çŸ­å‰£"},
    {id: 5, n: "äº”ã®æ¬ ç‰‡", j: "ãƒ•ãƒ¥ãƒ³ãƒ•", w: "äº”ä¹ƒæ–", a: "å…‰", wt: "æ–"},
    {id: 6, n: "å…­ã®æ¬ ç‰‡", j: "ã‚·ã‚¹", w: "å…­ä¹ƒæ‹³", a: "é—‡", wt: "æ‹³"},
    {id: 7, n: "ä¸ƒã®æ¬ ç‰‡", j: "ã‚·ã‚¨ãƒ†", w: "ä¸ƒä¹ƒå‰£", a: "é¢¨", wt: "å‰£"},
    {id: 8, n: "å…«ã®æ¬ ç‰‡", j: "ã‚ªã‚¯ãƒˆãƒ¼", w: "å…«ä¹ƒåˆ€", a: "åœŸ", wt: "åˆ€"},
    {id: 9, n: "ä¹ã®æ¬ ç‰‡", j: "ãƒ‹ã‚ª", w: "ä¹ä¹ƒç«ªç´", a: "é¢¨", wt: "ç´"},
    {id: 10, n: "åã®æ¬ ç‰‡", j: "ã‚¨ãƒƒã‚»ãƒ«", w: "åä¹ƒéŠƒ", a: "ç«", wt: "éŠƒ"}
];

function switchMSubTab(tab) {
    mCurrentTab = tab;
    document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + tab).classList.add('active');
    document.getElementById('m-weapon-box').style.display = (tab === 'shoukaku') ? 'block' : 'none';
    document.getElementById('m-stock-box').style.display = (tab === 'tense') ? 'none' : 'block';
    
    const labels = {
        quartz: ["ç›®æ¨™å€‹æ•°", "æ‰€æŒæ•°", "ä¸è¶³åˆ†"],
        shoukaku: ["ç›®æ¨™æ™¶æ ¸", "æ‰€æŒæ™¶æ ¸", "ä¸è¶³åˆ†"],
        tense: ["å¿…è¦æ¬ ç‰‡(åˆè¨ˆ)", "", "å®Ÿè³ªä¸è¶³åˆ†"]
    };
    document.getElementById('m-total-label').textContent = labels[tab][0];
    document.getElementById('m-stock-label').textContent = labels[tab][1];
    document.getElementById('m-need-label').textContent = labels[tab][2];
    
    renderM();
}

function renderM() {
    const container = document.getElementById('m-container');
    container.innerHTML = '';
    if (mCurrentTab === 'quartz') {
        const sages = [{a:"ç«", s:["ã‚¢ãƒ©ãƒŠãƒ³","ãƒ•ãƒ©ã‚¦"]},{a:"æ°´",s:["ãƒ†ãƒ¬ã‚µ","ãƒãƒ¼ã‚¼"]},{a:"åœŸ",s:["ã‚«ã‚¤ãƒ ","ãƒ­ãƒ™ãƒªã‚¢"]},{a:"é¢¨",s:["ã‚¨ã‚¹ã‚¿","ã‚«ãƒƒãƒ„ã‚§"]},{a:"å…‰",s:["ã‚¬ã‚¤ã‚¼ãƒ³"]},{a:"é—‡",s:["ãƒ‹ãƒ¼ã‚¢"]}];
        sages.forEach((g, i) => {
            let h = `<div class="m-card ${g.a}"><h3>${g.a}å±æ€§</h3>`;
            g.s.forEach((s, si) => {
                h += `<strong>${s}</strong><div class="item-list">`;
                [5,5,10,20,20,30].forEach((c, ci) => h += `<label><input type="checkbox" class="m-cb" data-cost="${c}" id="q-${i}-${si}-${ci}" onchange="saveM()">ç¤:${ci}å‡¸(${c})</label>`);
                h += `<label><input type="checkbox" class="m-cb" data-cost="30" id="q-${i}-${si}-abi" onchange="saveM()">4ã‚¢ãƒ“(30)</label></div>`;
            });
            h += `<strong>å…±é€š</strong><div class="item-list">`;
            ["çµ‚æœ«(ç¥)","çµ‚æœ«(ãƒ)","ç ´å£Š"].forEach(n => h += `<label><input type="checkbox" class="m-cb" data-cost="20" id="q-${i}-${n}" onchange="saveM()">${n}(20)</label>`);
            container.innerHTML += h + `</div></div>`;
        });
    } else if (mCurrentTab === 'shoukaku') {
        weaponMaster.forEach((m, i) => {
            let h = `<div class="m-card ${m.a}"><h3>æ¥µæ˜Ÿå™¨:${m.wt}</h3><div class="item-list">`;
            [{l:"3å‡¸ä½œæˆ",c:45},{l:"4å‡¸è§£æ”¾",c:45},{l:"5å‡¸è§£æ”¾",c:80},{l:"è¦šé†’å¼·åŒ–",c:170}].forEach((s, si) => h += `<label><input type="checkbox" class="m-cb" data-cost="${s.c}" id="s-${i}-${si}" onchange="saveM()">${s.l}(${s.c})</label>`);
            h += `</div><div style="margin-top:10px; font-size:12px">æ‰€æŒ(ç„¡å‡¸): <input type="number" id="ms-${i}" style="width:40px" oninput="saveM()"> æœ¬<br>ä¸è¶³: <span id="msd-${i}" style="color:red; font-weight:bold">0</span>å€‹</div></div>`;
            container.innerHTML += h;
        });
    } else if (mCurrentTab === 'tense') {
        weaponMaster.forEach((t, i) => {
            let h = `<div class="m-card ${t.a}"><h3>${t.n}(${t.j})</h3><div class="item-list">`;
            [{l:"è¶…è¶Š120",c:50},{l:"æ¥µæ˜Ÿ4å‡¸",c:20},{l:"æ¥µæ˜Ÿ5å‡¸",c:20},{l:"å…‰è·¡Lv4",c:20}].forEach((s, si) => h += `<label><input type="checkbox" class="m-cb" data-cost="${s.c}" id="t-${i}-${si}" onchange="saveM()">${s.l}(${s.c})</label>`);
            h += `</div><div style="margin-top:10px; font-size:11px">å¤©æ˜Ÿå™¨æ‰€æŒ: <input type="number" id="mt-${i}" style="width:40px" oninput="saveM()"> æœ¬<br>ä¸è¶³æ¬ ç‰‡: <span id="mtd-${i}" style="color:red; font-weight:bold">0</span> (è¦:<span id="mtw-${i}">0</span>æœ¬)</div></div>`;
            container.innerHTML += h;
        });
    }
    loadM();
}

function saveM() {
    const s = JSON.parse(localStorage.getItem(M_STORAGE_KEY) || '{"checks":{},"stocks":{},"headStocks":{}}');
    document.querySelectorAll('.m-cb').forEach(c => s.checks[c.id] = c.checked);
    if(mCurrentTab==='shoukaku') weaponMaster.forEach((_,i)=> s.stocks[`s-${i}`] = parseInt(document.getElementById(`ms-${i}`).value)||0);
    if(mCurrentTab==='tense') weaponMaster.forEach((_,i)=> s.stocks[`t-${i}`] = parseInt(document.getElementById(`mt-${i}`).value)||0);
    if(mCurrentTab!=='tense') s.headStocks[mCurrentTab] = parseInt(document.getElementById('m-stock-input').value)||0;
    localStorage.setItem(M_STORAGE_KEY, JSON.stringify(s));
    calcM(s);
}

function calcM(data) {
    let total = 0;
    document.querySelectorAll('.m-cb').forEach(c => { if(!c.checked) total += parseInt(c.dataset.cost); });
    let conv = 0;
    if(mCurrentTab==='shoukaku') {
        weaponMaster.forEach((_,i)=>{
            const c = data.stocks[`s-${i}`]||0; conv += (c*15);
            let n = 0; [0,1,2,3].forEach(si=>{ const cb=document.getElementById(`s-${i}-${si}`); if(cb && !cb.checked) n+=parseInt(cb.dataset.cost); });
            const diffEl = document.getElementById(`msd-${i}`); if(diffEl) diffEl.textContent = Math.max(0, n-(c*15));
        });
        document.getElementById('m-weapon-val').textContent = conv;
    }
    if(mCurrentTab==='tense') {
        let ts=0; weaponMaster.forEach((_,i)=>{
            const c=data.stocks[`t-${i}`]||0; let n=0; [0,1,2,3].forEach(si=>{ const cb=document.getElementById(`t-${i}-${si}`); if(cb && !cb.checked) n+=parseInt(cb.dataset.cost); });
            const cur=Math.floor(c/4)*5; const df=Math.max(0, n-cur); ts+=df;
            const dEl = document.getElementById(`mtd-${i}`); if(dEl) dEl.textContent=df;
            const wEl = document.getElementById(`mtw-${i}`); if(wEl) wEl.textContent=Math.max(0,(Math.ceil(df/5)*4)-(c%4));
        });
        document.getElementById('m-needed-total').textContent = ts;
    } else {
        const hs = data.headStocks[mCurrentTab]||0;
        document.getElementById('m-needed-total').textContent = Math.max(0, total-(hs+conv));
    }
    document.getElementById('m-grand-total').textContent = total;
}

function loadM() {
    const d = JSON.parse(localStorage.getItem(M_STORAGE_KEY) || '{"checks":{},"stocks":{},"headStocks":{}}');
    document.querySelectorAll('.m-cb').forEach(c => { if(d.checks[c.id]!==undefined) c.checked=d.checks[c.id]; });
    if(mCurrentTab==='shoukaku') weaponMaster.forEach((_,i)=> { const el = document.getElementById(`ms-${i}`); if(el) el.value = d.stocks[`s-${i}`]||0; });
    if(mCurrentTab==='tense') weaponMaster.forEach((_,i)=> { const el = document.getElementById(`mt-${i}`); if(el) el.value = d.stocks[`t-${i}`]||0; });
    if(mCurrentTab!=='tense') document.getElementById('m-stock-input').value = d.headStocks[mCurrentTab]||0;
    calcM(d);
}

function exportMData() {
    const d = localStorage.getItem(M_STORAGE_KEY);
    if(!d){alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");return;}
    const b=new Blob([d],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a');
    a.href=u; a.download=`GBF_Manager_Backup.json`; a.click();
}

function importMData(e) {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const json = JSON.parse(ev.target.result);
            if(confirm("ç´ æç®¡ç†ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.setItem(M_STORAGE_KEY, JSON.stringify(json));
                renderM();
            }
        } catch(err) { alert("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"); }
    };
    reader.readAsText(file);
}

/* ==========================================
   Tool 2: åå¤©è¡†é™ç•Œè¶…è¶Š
   ========================================== */
const T_STORAGE_KEY = 'GBF_TEN_TRANS_APP_DATA';
const characters = [{n:"ã‚¦ãƒ¼ãƒ", a:"æ°´", anima:"é»’éº’éºŸ"}, {n:"ã‚½ãƒ¼ãƒ³", a:"å…‰", anima:"é»„é¾"}, {n:"ã‚µãƒ©ãƒ¼ã‚µ", a:"åœŸ", anima:"é»„é¾"}, {n:"ã‚«ãƒˆãƒ«", a:"æ°´", anima:"é»’éº’éºŸ"}, {n:"ãƒ•ãƒ¥ãƒ³ãƒ•", a:"å…‰", anima:"é»„é¾"}, {n:"ã‚·ã‚¹", a:"é—‡", anima:"é»’éº’éºŸ"}, {n:"ã‚·ã‚¨ãƒ†", a:"é¢¨", anima:"é»’éº’éºŸ"}, {n:"ã‚ªã‚¯ãƒˆãƒ¼", a:"åœŸ", anima:"é»„é¾"}, {n:"ãƒ‹ã‚ª", a:"é¢¨", anima:"é»„é¾"}, {n:"ã‚¨ãƒƒã‚»ãƒ«", a:"ç«", anima:"é»’éº’éºŸ"}];
const commonMats = ["ãƒ«ãƒ”", "ãƒ’ãƒ’ã‚¤ãƒ­ã‚«ãƒ", "ç¢§éº—ã®è¨¼", "ãƒ€ãƒã‚¹ã‚«ã‚¹éª¸æ™¶", "æ˜Ÿæ™¶ã®æ¬ ç‰‡", "ç©¶ç«Ÿã®è¨¼", "JP", "æ „å…‰ã®è¨¼", "è¦‡è€…ã®è¨¼", "å®æ™¶çŸ³", "é»„é¾ã®ã‚¢ãƒ‹ãƒ", "é»’éº’éºŸã®ã‚¢ãƒ‹ãƒ", "çµ‚æœ«ã®æš—æ™¶", "æ¼†é»’ã®æ£˜ç¿…", "ç‹¡çŸ¥ã®é­”è§’", "ãƒãƒè§’", "çœŸé¾ã®é‡‘é±—"];
const attrMats = ["çœŸãªã‚‹ã‚¢ãƒ‹ãƒ", "éŠ€ç‰‡", "å…­ç«œç´ æ", "å…‰è¼ª", "ãƒã‚°ãƒŠIIã‚¢ãƒ‹ãƒ", "ãƒ—ã‚·ãƒ¥ã‚±ãƒ¼", "æ­¦å™¨ã‚¨ãƒ¬", "å±æ€§ã‚¨ãƒ¬", "ç«œç ", "ãƒ–ãƒ©ã‚¤ãƒˆ", "ä¸‹ä½å®ç ", "ã‚¸ãƒ¼ãƒ³", "æœ½ã¡æ­¦å™¨(ç„¡å‡¸)", "å¤©æ˜Ÿå™¨(ç„¡å‡¸)"];
const masterData = {
    110: { common:{"ãƒ«ãƒ”":100000, "ãƒ€ãƒã‚¹ã‚«ã‚¹éª¸æ™¶":20, "ãƒ’ãƒ’ã‚¤ãƒ­ã‚«ãƒ":1, "æ˜Ÿæ™¶ã®æ¬ ç‰‡":7500}, attr:{"å…­ç«œç´ æ":50, "å…‰è¼ª":80, "éŠ€ç‰‡":200, "ä¸‹ä½å®ç ":7500, "ã‚¸ãƒ¼ãƒ³":7500, "æœ½ã¡æ­¦å™¨(ç„¡å‡¸)":120} },
    120: { common:{"ãƒ«ãƒ”":5000000, "ç©¶ç«Ÿã®è¨¼":100, "JP":20000, "æ „å…‰ã®è¨¼":1500, "è¦‡è€…ã®è¨¼":300, "å®æ™¶çŸ³":1000, "ãƒãƒè§’":100}, attr:{"çœŸãªã‚‹ã‚¢ãƒ‹ãƒ":30, "ãƒã‚°ãƒŠIIã‚¢ãƒ‹ãƒ":50, "ãƒ—ã‚·ãƒ¥ã‚±ãƒ¼":300, "ä¸‹ä½å®ç ":2500, "ã‚¸ãƒ¼ãƒ³":2500, "æœ½ã¡æ­¦å™¨(ç„¡å‡¸)":40, "å¤©æ˜Ÿå™¨(ç„¡å‡¸)":40} },
    130: { common:{"ç¢§éº—ã®è¨¼":1} },
    140: { common:{"ãƒ«ãƒ”":5000000, "çœŸé¾ã®é‡‘é±—":50}, attr:{"ãƒ–ãƒ©ã‚¤ãƒˆ":30, "æ­¦å™¨ã‚¨ãƒ¬":2000, "å±æ€§ã‚¨ãƒ¬":2000, "ç«œç ":300} },
    150: { common:{"çµ‚æœ«ã®æš—æ™¶":30, "æ¼†é»’ã®æ£˜ç¿…":30, "ç‹¡çŸ¥ã®é­”è§’":30, "ç¢§éº—ã®è¨¼":1} }
};

let tData = { chars: {}, stocks: {} };
let tActiveTab = 'Common';

function initT() {
    const saved = localStorage.getItem(T_STORAGE_KEY);
    if(saved) { try { tData = JSON.parse(saved); } catch(e) {} }
    renderTSettings();
}

function renderTSettings() {
    const container = document.getElementById('t-char-settings');
    container.innerHTML = '';
    characters.forEach(c => {
        if(!tData.chars[c.n]) tData.chars[c.n] = {cur:100, tar:100, fin:false};
        const d = tData.chars[c.n];
        const attrClass = {ç«:'fire',æ°´:'water',åœŸ:'earth',é¢¨:'wind',å…‰:'light',é—‡:'dark'}[c.a];
        container.innerHTML += `
            <div class="char-item ${d.fin ? 'finished' : ''}" style="border-top-color:var(--${attrClass})">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px">
                    <strong style="font-size:13px">${c.n}</strong>
                    <input type="checkbox" onchange="toggleTFin('${c.n}',this.checked)" ${d.fin?'checked':''}>
                </div>
                <div style="display:flex; align-items:center; gap:2px;">
                    <select style="flex:1" onchange="updateTChar('${c.n}','cur',this.value)" ${d.fin?'disabled':''}>${[100,110,120,130,140,150].map(v=>`<option value="${v}" ${d.cur==v?'selected':''}>${v}</option>`)}</select>
                    <span>â–¶</span>
                    <select style="flex:1" onchange="updateTChar('${c.n}','tar',this.value)" ${d.fin?'disabled':''}>${[100,110,120,130,140,150].map(v=>`<option value="${v}" ${d.tar==v?'selected':''}>${v}</option>`)}</select>
                </div>
            </div>`;
    });
    switchTInputTab(tActiveTab);
    calcT();
}

function updateTChar(n, k, v) { tData.chars[n][k] = parseInt(v); calcT(); }
function toggleTFin(n, c) { tData.chars[n].fin = c; renderTSettings(); }
function switchTInputTab(t) {
    tActiveTab = t;
    document.querySelectorAll('.t-tab-btn').forEach(b => b.classList.toggle('active', b.innerText === t));
    const container = document.getElementById('t-stock-inputs'); container.innerHTML = '';
    const list = (t === 'Common') ? commonMats : attrMats;
    list.forEach(m => {
        const id = t === 'Common' ? m : `${t}-${m}`;
        const val = tData.stocks[id] || 0;
        container.innerHTML += `<div><label style="display:block;font-size:10px;margin-bottom:2px;">${m}</label><input type="number" value="${val}" oninput="updateTStock('${id}',this.value)"></div>`;
    });
}
function updateTStock(id, v) { tData.stocks[id] = parseInt(v)||0; calcT(); }

function calcT() {
    const needed = {};
    characters.forEach(c => {
        const d = tData.chars[c.n]; if(d.fin || d.tar <= d.cur) return;
        for(let lv in masterData) {
            const num = parseInt(lv);
            if(num > d.cur && num <= d.tar) {
                for(let m in masterData[lv].common) needed[m] = (needed[m]||0) + masterData[lv].common[m];
                for(let m in masterData[lv].attr) { const key=`${c.a}-${m}`; needed[key] = (needed[key]||0) + masterData[lv].attr[m]; }
                if(num === 140) { const ak=`${c.anima}ã®ã‚¢ãƒ‹ãƒ`; needed[ak] = (needed[ak]||0)+30; }
            }
        }
    });
    const container = document.getElementById('t-result-container'); container.innerHTML = '';
    ["å…±é€š", "ç«", "æ°´", "åœŸ", "é¢¨", "å…‰", "é—‡"].forEach(cat => {
        const items = Object.keys(needed).filter(k => cat === "å…±é€š" ? (commonMats.includes(k) || (k.includes("ã‚¢ãƒ‹ãƒ") && !k.includes("-"))) : k.startsWith(cat + "-"));
        if(items.length > 0) {
            let h = `<div style="background:#eee; padding:5px; margin:10px 0 5px; font-weight:bold; border-radius:4px;">${cat}</div><table>`;
            items.sort().forEach(k => {
                const s = tData.stocks[k]||0; const df = needed[k]-s;
                h += `<tr class="${df<=0?'':'status-ng'}"><td>${df<=0?'<span style="color:#2ecc71">âœ“</span> ':''}${k.includes("-")?k.split("-")[1]:k}</td><td style="text-align:right">${needed[k].toLocaleString()}</td><td style="text-align:right">${df<=0?'-':df.toLocaleString()}</td></tr>`;
            });
            container.innerHTML += h + `</table>`;
        }
    });
}

function saveT() { localStorage.setItem(T_STORAGE_KEY, JSON.stringify(tData)); alert("ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸ"); }
function downloadT() { const b=new Blob([JSON.stringify(tData,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download="gbf_trans_data.json"; a.click(); }
function uploadTFile(e) {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            tData = JSON.parse(ev.target.result);
            renderTSettings();
            alert("è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        } catch(err) { alert("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"); }
    };
    reader.readAsText(file);
}

// èµ·å‹•å‡¦ç†
window.onload = () => {
    switchMSubTab('quartz');
    initT();
};
</script>
</body>
</html>
