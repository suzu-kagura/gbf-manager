<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBF Manager</title>
    <style>
        :root {
            --fire: #ffeded; --fire-line: #f44336;
            --water: #e3f2fd; --water-line: #2196f3;
            --earth: #fdf5e6; --earth-line: #795548;
            --wind: #e8f5e9; --wind-line: #4caf50;
            --light: #fffde7; --light-line: #fbc02d;
            --dark: #f3e5f5; --dark-line: #9c27b0;
            --accent: #2c3e50; --needed: #e74c3c;
        }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; padding-top: 60px; }
        
        /* ヘッダー・メニュー周り */
        .tab-menu { position: fixed; top: 0; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 8px; padding: 10px; background: #f0f2f5; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { padding: 8px 16px; border: none; border-radius: 20px; background: #ddd; cursor: pointer; font-weight: bold; font-size: 0.85em; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: white; }

        /* データ管理ボタン（タブの横） */
        .backup-group { display: flex; gap: 4px; margin-left: 10px; border-left: 1px solid #ccc; padding-left: 10px; }
        .backup-btn { font-size: 0.7em; padding: 6px 10px; border-radius: 6px; border: 1px solid #bbb; background: #fff; cursor: pointer; font-weight: bold; color: #555; }
        .backup-btn:hover { background: #eee; }
        
        .header { position: sticky; top: 55px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; z-index: 100; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; }
        .calc-box { text-align: center; min-width: 90px; }
        .calc-box label { font-size: 0.75em; color: #666; display: block; margin-bottom: 4px; font-weight: bold; }
        .val { font-size: 1.4em; font-weight: bold; }
        .needed-val { color: var(--needed); }
        .stock-input { font-size: 1.2em; width: 85px; text-align: center; border: 2px solid #ddd; border-radius: 8px; font-weight: bold; padding: 4px; }
        
        .shoukaku-only { display: none; }
        body.tab-shoukaku .shoukaku-only { display: block; }

        /* カード・グリッド */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; border: 1px solid #ddd; overflow: hidden; position: relative; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 8px; }
        .attr-火 { background-color: var(--fire); } .attr-火::before { background-color: var(--fire-line); }
        .attr-水 { background-color: var(--water); } .attr-水::before { background-color: var(--water-line); }
        .attr-土 { background-color: var(--earth); } .attr-土::before { background-color: var(--earth-line); }
        .attr-風 { background-color: var(--wind); } .attr-風::before { background-color: var(--wind-line); }
        .attr-光 { background-color: var(--light); } .attr-光::before { background-color: var(--light-line); }
        .attr-闇 { background-color: var(--dark); } .attr-闇::before { background-color: var(--dark-line); }

        .group-title { font-size: 0.8em; font-weight: bold; margin: 10px 0 5px; background: rgba(255,255,255,0.5); padding: 4px 10px; border-radius: 4px; border-left: 4px solid #444; }
        .item-grid { display: grid; grid-template-columns: 1fr; gap: 4px; }
        label { display: flex; align-items: center; background: rgba(255,255,255,0.8); padding: 10px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; border: 1px solid rgba(0,0,0,0.05); }
        label:has(input:checked) { background: rgba(0,0,0,0.05); color: #999; text-decoration: line-through; border-color: transparent; }
        input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
        
        .card-calc { margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em; }
        .card-stock-input { width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; }
        .card-result { font-weight: bold; border-left: 1px solid rgba(0,0,0,0.1); padding-left: 10px; }
        .txt-red { color: var(--needed); }
        .stock-label { font-size: 0.75em; color: #666; display: block; margin-top: 2px; }
    </style>
</head>
<body class="tab-quartz">

<div class="tab-menu">
    <button class="tab-btn active" id="btn-quartz" onclick="switchTab('quartz')">クォーツ</button>
    <button class="tab-btn" id="btn-shoukaku" onclick="switchTab('shoukaku')">晶核</button>
    <button class="tab-btn" id="btn-tense" onclick="switchTab('tense')">天星</button>
    
    <div class="backup-group">
        <button class="backup-btn" title="エクスポート" onclick="exportData()">保存</button>
        <button class="backup-btn" title="インポート" onclick="document.getElementById('importFile').click()">復元</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</div>

<div class="header">
    <div class="calc-box"><label id="header-total-label">目標個数</label><div class="val" id="grand-total">0</div></div>
    <div class="calc-box shoukaku-only"><label>武器所持晶核</label><div class="val" id="weapon-conv-val">0</div></div>
    <div class="calc-box header-stock-box"><label id="header-stock-label">所持数</label><input type="number" id="stock" class="stock-input" value="0" oninput="saveData()"></div>
    <div class="calc-box header-needed-box"><label>不足分</label><div class="val needed-val" id="needed-total">0</div></div>
</div>

<div id="main-container" class="grid"></div>

<script>
    let currentTab = 'quartz';
    const STORAGE_KEY = 'gbf_manager_data_unified';
    
    const weaponMaster = [
        {id: 1, n: "一の欠片", j: "ウーノ", w: "一乃矛", a: "水", wt: "槍"},
        {id: 2, n: "二の欠片", j: "ソーン", w: "二乃弓", a: "光", wt: "弓"},
        {id: 3, n: "三の欠片", j: "サラーサ", w: "三乃斧", a: "土", wt: "斧"},
        {id: 4, n: "四の欠片", j: "カトル", w: "四乃短剣", a: "水", wt: "短剣"},
        {id: 5, n: "五の欠片", j: "フュンフ", w: "五乃杖", a: "光", wt: "杖"},
        {id: 6, n: "六の欠片", j: "シス", w: "六乃拳", a: "闇", wt: "拳"},
        {id: 7, n: "七の欠片", j: "シエテ", w: "七乃剣", a: "風", wt: "剣"},
        {id: 8, n: "八の欠片", j: "オクトー", w: "八乃刀", a: "土", wt: "刀"},
        {id: 9, n: "九の欠片", j: "ニオ", w: "九乃竪琴", a: "風", wt: "琴"},
        {id: 10, n: "十の欠片", j: "エッセル", w: "十乃銃", a: "火", wt: "銃"}
    ];

    // --- データ入出力 ---
    function exportData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) { alert("保存されているデータがありません。"); return; }
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toLocaleDateString('ja-JP').replace(/\//g, '-');
        a.href = url;
        a.download = `GBF_Manager_Backup_${date}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (confirm("現在のデータを上書きしてバックアップを復元しますか？")) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(json));
                    location.reload();
                }
            } catch (err) {
                alert("ファイルの形式が正しくありません。");
            }
        };
        reader.readAsText(file);
    }

    function render() {
        const container = document.getElementById('main-container');
        container.innerHTML = '';
        
        if (currentTab === 'quartz') {
            const sages = [
                {a: "火", s: ["アラナン","フラウ"]}, {a: "水", s: ["テレサ","ハーゼ"]}, {a: "土", s: ["カイム","ロベリア"]},
                {a: "風", s: ["エスタ","カッツェ"]}, {a: "光", s: ["ガイゼン"]}, {a: "闇", s: ["ニーア"]}
            ];
            sages.forEach((group, i) => {
                let html = `<div class="card attr-${group.a}"><h3>${group.a}属性</h3>`;
                group.s.forEach((s, si) => {
                    html += `<div class="group-title">${s}</div><div class="item-grid">`;
                    [5,5,10,20,20,30].forEach((c, ci) => html += `<label><input type="checkbox" class="q-check" data-cost="${c}" id="q-${i}-${si}-${ci}" onchange="saveData()">礎:${ci}凸(${c})</label>`);
                    html += `<label><input type="checkbox" class="q-check" data-cost="30" id="q-${i}-${si}-abi" onchange="saveData()">4アビ(30)</label></div>`;
                });
                html += `<div class="group-title">共通</div><div class="item-grid">`;
                ["終末(神)","終末(マ)","破壊"].forEach(n => html += `<label><input type="checkbox" class="q-check" data-cost="20" id="q-${i}-${n}" onchange="saveData()">${n}(20)</label>`);
                html += `</div></div>`;
                container.innerHTML += html;
            });
        } 
        else if (currentTab === 'shoukaku') {
            weaponMaster.forEach((m, i) => {
                let html = `<div class="card attr-${m.a}"><h3>極星器：${m.wt}</h3><div class="item-grid">`;
                const steps = [{l:"3凸作成(掘り)", c:45}, {l:"4凸解放", c:45}, {l:"5凸解放", c:80}, {l:"覚醒強化", c:170}];
                steps.forEach((s, si) => html += `<label><input type="checkbox" class="q-check" data-cost="${s.c}" id="s-${i}-${si}" onchange="saveData()">${s.l}(${s.c})</label>`);
                html += `</div><div class="card-calc"><div><span class="stock-label">所持本数(無凸)</span><input type="number" id="sstock-${i}" class="card-stock-input" value="0" oninput="saveData()"> 本</div><div class="card-result">不足:<span id="sdiff-${i}" class="txt-red">0</span>個</div></div></div>`;
                container.innerHTML += html;
            });
        }
        else if (currentTab === 'tense') {
            weaponMaster.forEach((t, i) => {
                let html = `<div class="card attr-${t.a}"><h3>${t.n} (${t.j})</h3><div class="item-grid">`;
                const steps = [{l:"超越Lv120解放", c:50}, {l:"極星器 4凸", c:20}, {l:"極星器 5凸", c:20}, {l:"光跡武器 Lv4強化", c:20}];
                steps.forEach((s, si) => html += `<label><input type="checkbox" class="q-check" data-cost="${s.c}" id="t-${i}-${si}" onchange="saveData()">${s.l}(${s.c})</label>`);
                html += `</div><div class="card-calc"><div><span class="stock-label">天星器所持(無凸)</span><input type="number" id="tstock-${i}" class="card-stock-input" value="0" oninput="saveData()"> 本</div><div class="card-result">不足欠片:<span id="tdiff-${i}" class="txt-red">0</span><br><small>要追加:</small><span id="tweap-${i}">0</span>本</div></div></div>`;
                container.innerHTML += html;
            });
        }
        loadData();
    }

    function switchTab(tab) {
        currentTab = tab;
        document.body.className = 'tab-' + tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tab).classList.add('active');
        const hLabel = document.getElementById('header-total-label');
        const sLabel = document.getElementById('header-stock-label');
        
        if(tab === 'shoukaku') { hLabel.textContent = '目標晶核'; sLabel.textContent = '所持晶核'; }
        else if(tab === 'tense') { hLabel.textContent = '必要欠片(合計)'; sLabel.textContent = '所持欠片'; }
        else { hLabel.textContent = '目標個数'; sLabel.textContent = '所持数'; }
        render();
    }

    function saveData() {
        const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"checks":{}, "stocks":{}, "headStocks":{}}');
        const data = { checks: {...stored.checks}, stocks: {...stored.stocks}, headStocks: {...stored.headStocks} };

        document.querySelectorAll('.q-check').forEach(cb => { data.checks[cb.id] = cb.checked; });
        if(currentTab === 'shoukaku') weaponMaster.forEach((m, i) => { data.stocks[`s-${i}`] = parseInt(document.getElementById(`sstock-${i}`).value) || 0; });
        if(currentTab === 'tense') weaponMaster.forEach((m, i) => { data.stocks[`t-${i}`] = parseInt(document.getElementById(`tstock-${i}`).value) || 0; });
        
        data.headStocks[currentTab] = parseInt(document.getElementById('stock').value) || 0;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        calculate(data);
    }

    function calculate(data) {
        let grandTotal = 0;
        document.querySelectorAll('.q-check').forEach(cb => { if(!cb.checked) grandTotal += parseInt(cb.dataset.cost); });
        let weaponConvTotal = 0;

        if (currentTab === 'shoukaku') {
            weaponMaster.forEach((m, i) => {
                const count = data.stocks[`s-${i}`] || 0;
                weaponConvTotal += (count * 15);
                let cardNeed = 0;
                [0,1,2,3].forEach(si => { const cb = document.getElementById(`s-${i}-${si}`); if(cb && !cb.checked) cardNeed += parseInt(cb.dataset.cost); });
                document.getElementById(`sdiff-${i}`).textContent = Math.max(0, cardNeed - (count * 15));
            });
            document.getElementById('weapon-conv-val').textContent = weaponConvTotal;
        }
        if (currentTab === 'tense') {
            weaponMaster.forEach((t, i) => {
                const count = data.stocks[`t-${i}`] || 0;
                let need = 0;
                [0,1,2,3].forEach(si => { const cb = document.getElementById(`t-${i}-${si}`); if(cb && !cb.checked) need += parseInt(cb.dataset.cost); });
                const currentKakeStock = Math.floor(count / 4) * 5;
                const diffKake = Math.max(0, need - currentKakeStock);
                document.getElementById(`tdiff-${i}`).textContent = diffKake;
                document.getElementById(`tweap-${i}`).textContent = Math.max(0, (Math.ceil(diffKake / 5) * 4) - (count % 4));
            });
        }
        document.getElementById('grand-total').textContent = grandTotal;
        const headStock = data.headStocks[currentTab] || 0;
        document.getElementById('needed-total').textContent = Math.max(0, grandTotal - (headStock + weaponConvTotal));
    }

    function loadData() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"checks":{}, "stocks":{}, "headStocks":{}}');
        document.querySelectorAll('.q-check').forEach(cb => { if(data.checks[cb.id] !== undefined) cb.checked = data.checks[cb.id]; });
        if(currentTab === 'shoukaku') weaponMaster.forEach((m, i) => { const el = document.getElementById(`sstock-${i}`); if(el) el.value = data.stocks[`s-${i}`] || 0; });
        if(currentTab === 'tense') weaponMaster.forEach((m, i) => { const el = document.getElementById(`tstock-${i}`); if(el) el.value = data.stocks[`t-${i}`] || 0; });
        document.getElementById('stock').value = data.headStocks[currentTab] || 0;
        calculate(data);
    }
    render();
</script>
</body>
</html>
