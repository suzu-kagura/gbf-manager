<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神石計算機</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; color: #334155; max-width: 900px; margin: 0 auto; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 25px; }
        .config-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; background: #f1f5f9; padding: 20px; border-radius: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .pattern-card { border: 2px solid var(--border); border-radius: 12px; padding: 15px; background: #fff; }
        .pattern-title { font-weight: bold; color: var(--primary); font-size: 0.95rem; border-bottom: 1px solid #f1f5f9; margin-bottom: 10px; padding-bottom: 5px; }
        .data-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-ng { background: #fee2e2; color: #991b1b; }
        .highlight { font-weight: bold; color: #2563eb; }
        .summary-info { margin-bottom: 20px; font-size: 0.9rem; color: #64748b; border-left: 4px solid #3b82f6; padding-left: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1>神石計算機</h1>

    <div class="config-section">
        <div class="input-item">
            <label>現在の段階</label>
            <select id="curStep">
                <option value="0">0凸</option><option value="1">1凸</option>
                <option value="2">2凸</option><option value="3">3凸</option>
                <option value="4">4凸</option><option value="5">5凸</option>
                <option value="6">超越210</option><option value="7">超越220</option>
                <option value="8">超越230</option><option value="9">超越240</option>
            </select>
        </div>
        <div class="input-item">
            <label>目標の段階</label>
            <select id="tarStep">
                <option value="3">3凸</option><option value="4">4凸</option>
                <option value="5">5凸</option>
                <option value="6">超越210</option><option value="7">超越220</option>
                <option value="8">超越230</option><option value="9">超越240</option>
                <option value="10" selected>超越250</option>
            </select>
        </div>
        <div class="input-item">
            <label>余り素体数(無凸)</label>
            <input type="number" id="ownedCopies" value="2" min="0">
        </div>
    </div>

    <div id="summary" class="summary-info"></div>
    <div id="results" class="results-grid"></div>
</div>

<script>
    function render() {
        const cur = parseInt(document.getElementById('curStep').value);
        const tar = parseInt(document.getElementById('tarStep').value);
        const owned = parseInt(document.getElementById('ownedCopies').value) || 0;
        const area = document.getElementById('results');
        const summary = document.getElementById('summary');
        
        area.innerHTML = "";
        if (cur >= tar) { summary.innerText = "目標達成済みです。"; return; }

        // 1. 上限解放に必要なコスト
        // 0->3凸に必要な数 (金剛または素体で代用可能)
        const stepsTo3 = Math.max(0, Math.min(3, tar) - Math.min(3, cur));
        // 4凸以降に必要な「アニマ」の総数
        let totalAnimaNeeded = 0;
        if (tar >= 4 && cur < 4) totalAnimaNeeded += 1;
        if (tar >= 5 && cur < 5) totalAnimaNeeded += 1;
        if (tar >= 6) totalAnimaNeeded += (Math.min(tar, 10) - Math.max(cur, 5));

        summary.innerHTML = `目標達成に必要な「アニマ」の数: <b>${totalAnimaNeeded} 個</b><br>` +
                           (stepsTo3 > 0 ? `3凸までに必要な解放回数: <b>${stepsTo3} 回</b>` : "");

        // 2. パターン生成
        // パターンA: 手持ちを「上限解放」に優先して使う
        // パターンB: 手持ちを「アニマ確保」に優先して使う
        const strategies = [
            { id: 'saveSun', name: '素体を解放に優先 (金剛節約)' },
            { id: 'saveAnima', name: '素体をアニマに優先 (アニマ確保)' }
        ];

        strategies.forEach(strat => {
            let tempOwned = owned;
            let usedForStep = 0;
            let sunForStep = stepsTo3;

            if (strat.id === 'saveSun') {
                usedForStep = Math.min(tempOwned, stepsTo3);
                tempOwned -= usedForStep;
                sunForStep = stepsTo3 - usedForStep;
            }

            // 残った素体(tempOwned)をどう砕くかの全パターン
            const subPatterns = getCrushPatterns(tempOwned);
            
            subPatterns.forEach(p => {
                const totalAnimaGot = p.totalAnima;
                const isPossible = totalAnimaGot >= totalAnimaNeeded;
                
                const card = document.createElement('div');
                card.className = 'pattern-card';
                
                let crushDesc = p.combination.length > 0 ? p.combination.join(' + ') : "砕く素体なし";
                
                card.innerHTML = `
                    <div class="pattern-title">${strat.name}</div>
                    <div class="data-row"><span>3凸用金剛晶:</span><span class="highlight">${sunForStep}個</span></div>
                    <div class="data-row"><span>素体消費(解放):</span><span>${usedForStep}枚</span></div>
                    <div class="data-row"><span>砕く構成:</span><span>${crushDesc}</span></div>
                    <div class="data-row"><span>砕く用金剛晶:</span><span class="highlight">${p.sunUsed}個</span></div>
                    <hr style="border:0; border-top:1px solid #eee;">
                    <div class="data-row">
                        <span>合計金剛晶:</span><span class="highlight" style="color:#e11d48">${sunForStep + p.sunUsed}個</span>
                    </div>
                    <div class="data-row">
                        <span>獲得アニマ:</span>
                        <span>${totalAnimaGot} / ${totalAnimaNeeded} <span class="tag ${isPossible ? 'tag-ok' : 'tag-ng'}">${isPossible ? 'OK' : '不足'}</span></span>
                    </div>
                `;
                area.appendChild(card);
            });
        });
    }

    // 砕くパターンの生成 (再帰)
    function getCrushPatterns(count) {
        let results = [];
        if (count === 0) return [{ combination: [], totalAnima: 0, sunUsed: 0 }];

        function backtrack(idx, currentAnima, currentSun, currentPath) {
            if (idx === count) {
                results.push({ combination: [...currentPath], totalAnima: currentAnima, sunUsed: currentSun });
                return;
            }
            // 0凸〜3凸にして砕く
            for (let t = 0; t <= 3; t++) {
                let gain = (t === 3) ? 4 : t + 1;
                currentPath.push(t === 0 ? "無凸" : t + "凸");
                backtrack(idx + 1, currentAnima + gain, currentSun + t, currentPath);
                currentPath.pop();
            }
        }
        backtrack(0, 0, 0, []);
        
        // 重複除去 (ソートして文字列キーで管理)
        let unique = {};
        results.forEach(r => {
            r.combination.sort();
            let key = r.combination.join('|') + r.totalAnima;
            if (!unique[key]) unique[key] = r;
        });
        return Object.values(unique).sort((a,b) => a.sunUsed - b.sunUsed);
    }

    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', render));
    render();
</script>

</body>
</html>
