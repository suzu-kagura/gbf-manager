<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神石計算機</title>
    <style>
        :root { --primary: #2563eb; --success: #166534; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); padding: 20px; color: #334155; max-width: 900px; margin: 0 auto; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 25px; font-size: 1.6rem; }
        .config-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; background: #f1f5f9; padding: 20px; border-radius: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; background: #fff; }
        
        .summary-info { margin-bottom: 20px; font-size: 0.95rem; color: #475569; border-left: 5px solid var(--primary); padding: 10px 15px; background: #eff6ff; border-radius: 0 8px 8px 0; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .pattern-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 18px; background: #fff; transition: transform 0.2s; }
        .pattern-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .pattern-title { font-weight: bold; color: var(--success); font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .tag-ok { font-size: 0.7rem; background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 99px; }
        
        .data-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 6px; }
        .val { font-weight: bold; }
        .highlight-sun { color: #e11d48; font-size: 1.1rem; }
        hr { border: 0; border-top: 1px solid #f1f5f9; margin: 10px 0; }
        .empty-msg { text-align: center; grid-column: 1 / -1; padding: 40px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="card">
    <h1>神石計算機</h1>

    <div class="config-section">
        <div class="input-item">
            <label>現在の段階</label>
            <select id="curStep">
                <option value="0">0凸</option><option value="1">1凸</option>
                <option value="2">2凸</option><option value="3">3凸</option>
                <option value="4">4凸</option><option value="5">5凸</option>
                <option value="6">210</option><option value="7">220</option>
                <option value="8">230</option><option value="9">240</option>
            </select>
        </div>
        <div class="input-item">
            <label>目標の段階</label>
            <select id="tarStep">
                <option value="3">3凸</option><option value="4">4凸</option>
                <option value="5">5凸</option>
                <option value="6">210</option><option value="7">220</option>
                <option value="8">230</option><option value="9">240</option>
                <option value="10" selected>250(超越)</option>
            </select>
        </div>
        <div class="input-item">
            <label>余り素体数(無凸)</label>
            <input type="number" id="ownedCopies" value="2" min="0">
        </div>
    </div>

    <div id="summary" class="summary-info"></div>
    <div id="results" class="results-grid"></div>
</div>

<script>
    function render() {
        const cur = parseInt(document.getElementById('curStep').value);
        const tar = parseInt(document.getElementById('tarStep').value);
        const owned = parseInt(document.getElementById('ownedCopies').value) || 0;
        const area = document.getElementById('results');
        const summary = document.getElementById('summary');
        
        area.innerHTML = "";
        if (cur >= tar) { summary.innerText = "目標達成済みです。"; return; }

        // 必要な解放回数とアニマ数
        const stepsTo3 = Math.max(0, Math.min(3, tar) - Math.min(3, cur));
        let totalAnimaNeeded = 0;
        if (tar >= 4 && cur < 4) totalAnimaNeeded += 1;
        if (tar >= 5 && cur < 5) totalAnimaNeeded += 1;
        if (tar >= 6) totalAnimaNeeded += (Math.min(tar, 10) - Math.max(cur, 5));

        summary.innerHTML = `必要アニマ: <b>${totalAnimaNeeded}個</b> / 3凸までの解放回数: <b>${stepsTo3}回</b>`;

        let validPatternsFound = 0;

        // 戦略ループ
        ['saveSun', 'saveAnima'].forEach(stratId => {
            let tempOwned = owned;
            let usedForStep = 0;
            let sunForStep = stepsTo3;

            if (stratId === 'saveSun') {
                usedForStep = Math.min(tempOwned, stepsTo3);
                tempOwned -= usedForStep;
                sunForStep = stepsTo3 - usedForStep;
            }

            // 砕きパターンの取得
            const subPatterns = getCrushPatterns(tempOwned);
            
            subPatterns.forEach(p => {
                if (p.totalAnima >= totalAnimaNeeded) {
                    validPatternsFound++;
                    const card = document.createElement('div');
                    card.className = 'pattern-card';
                    
                    let crushDesc = p.combination.length > 0 ? p.combination.join(' + ') : "砕きなし";
                    let stratName = stratId === 'saveSun' ? "金剛節約ルート" : "アニマ確保ルート";

                    card.innerHTML = `
                        <div class="pattern-title"><span>${stratName}</span> <span class="tag-ok">達成可能</span></div>
                        <div class="data-row"><span>素体を解放に利用:</span><span class="val">${usedForStep}枚</span></div>
                        <div class="data-row"><span>素体を砕く構成:</span><span class="val">${crushDesc}</span></div>
                        <hr>
                        <div class="data-row"><span>解放用金剛晶:</span><span class="val">${sunForStep}個</span></div>
                        <div class="data-row"><span>砕く用金剛晶:</span><span class="val">${p.sunUsed}個</span></div>
                        <div class="data-row" style="margin-top:5px;">
                            <span>合計金剛晶:</span><span class="val highlight-sun">${sunForStep + p.sunUsed}個</span>
                        </div>
                        <div class="data-row" style="color:#64748b; font-size:0.8rem;">
                            <span>獲得アニマ:</span><span>${p.totalAnima} (余剰: ${p.totalAnima - totalAnimaNeeded})</span>
                        </div>
                    `;
                    area.appendChild(card);
                }
            });
        });

        if (validPatternsFound === 0) {
            area.innerHTML = `<div class="empty-msg">条件を満たせるパターンが見つかりませんでした。<br>素体が不足しているか、目標が高すぎます。</div>`;
        }
    }

    function getCrushPatterns(count) {
        let results = [];
        if (count === 0) return [{ combination: [], totalAnima: 0, sunUsed: 0 }];

        function backtrack(idx, currentAnima, currentSun, currentPath) {
            if (idx === count) {
                results.push({ combination: [...currentPath], totalAnima: currentAnima, sunUsed: currentSun });
                return;
            }
            // 0凸〜3凸にして砕く (3凸はアニマ4個。4凸以上はアニマ効率が悪いため除外)
            for (let t = 0; t <= 3; t++) {
                let gain = (t === 3) ? 4 : t + 1;
                currentPath.push(t === 0 ? "無凸" : t + "凸");
                backtrack(idx + 1, currentAnima + gain, currentSun + t, currentPath);
                currentPath.pop();
            }
        }
        backtrack(0, 0, 0, []);
        
        let unique = {};
        results.forEach(r => {
            r.combination.sort();
            let key = r.combination.join('|') + r.totalAnima + r.sunUsed;
            if (!unique[key]) unique[key] = r;
        });
        return Object.values(unique).sort((a,b) => a.sunUsed - b.sunUsed);
    }

    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', render));
    render();
</script>

</body>
</html>
